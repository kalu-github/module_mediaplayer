!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).slardarPluginImageReport=t()}(this,function(){"use strict";var x=function(){return(x=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function z(e,a,u,c){return new(u=u||Promise)(function(n,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function o(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(r,o)}i((c=c.apply(e,a||[])).next())})}function R(r,o){var i,a,u,c={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,a&&(u=2&t[0]?a.return:t[0]?a.throw||((u=a.return)&&u.call(a),0):a.next)&&!(u=u.call(a,t[1])).done)return u;switch(a=0,(t=u?[2&t[0],u.value]:t)[0]){case 0:case 1:u=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(u=0<(u=c.trys).length&&u[u.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!u||t[1]>u[0]&&t[1]<u[3])){c.label=t[1];break}if(6===t[0]&&c.label<u[1]){c.label=u[1],u=t;break}if(u&&c.label<u[2]){c.label=u[2],c.ops.push(t);break}u[2]&&c.ops.pop(),c.trys.pop();continue}t=o.call(r,c)}catch(e){t=[6,e],a=0}finally{i=u=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}}function M(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function N(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a}function s(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||((r=r||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}function c(){return{}}function t(e){return"object"==typeof e&&null!==e}var a=Object.prototype;function y(e){return"function"==typeof e}function C(e){{if("[object Array]"!==a.toString.call(e))return null;if(e.length){for(var t=e,n=[],r=t.length,o=0;o<r;o++){var i=t[o];"string"==typeof i?n.push(i.replace(/([.*+?^=!:${}()|[\]/\\])/g,"\\$1")):i&&i.source&&n.push(i.source)}return new RegExp(n.join("|"),"i")}return null}}function l(i,a,u){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!i)return c;var n=i[a],r=u.apply(void 0,s([n],N(e),!1)),o=r;return y(o)&&(o=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return r.apply(this,e)}),i[a]=o,function(){o===i[a]?i[a]=n:r=n}}}var o=0,T=function(e){return Math.random()<Number(e)};function k(){if("object"==typeof window&&t(window))return window}function A(){if("object"==typeof document&&t(document))return document}var i=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=function(e){if(e)return e.__SLARDAR_REGISTRY__||(e.__SLARDAR_REGISTRY__={Slardar:{plugins:[],errors:[],subject:{}}}),e.__SLARDAR_REGISTRY__.Slardar}(k());n&&(n.errors||(n.errors=[]),n.errors.push(e))},D=function(e,t){var n=e&&new e(t);return[function(e,t){n&&e&&n.observe(e,t)},function(){return n&&n.disconnect()}]},j=function(n){var e=n&&n.timing||void 0;return[e,function(){return n&&n.now?n.now():(Date.now?Date.now():+new Date)-(e&&e.navigationStart||0)},function(e){var t=(n||{}).getEntriesByType;return y(t)&&t.call(n,e)||[]},function(){var e=(n||{}).clearResourceTimings;y(e)&&e.call(n)},function(e){var t=(n||{}).getEntriesByName;return y(t)&&t.call(n,e)||[]}]},W=function(n,o,t,i){var r=n&&new n(function(e,r){e.getEntries?e.getEntries().forEach(function(e,t,n){return o(e,t,n,r)}):i&&i(),t&&r.disconnect()});return[function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!n||!r)return i&&i();try{t.forEach(function(e){-1<n.supportedEntryTypes.indexOf(e)&&r.observe({type:e,buffered:!1})})}catch(e){try{r.observe({entryTypes:t})}catch(e){return i&&i()}}},function(){return r&&r.disconnect()}]};var F=function(n,e){return void 0===n&&(n="SlardarPlugins"),(e=void 0===e?!1:e)?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return console.log.apply(console,s(["[".concat(n,"] ")],N(e),!1))}:function(){}},d=(e.prototype.subscribe=function(e){this.observers.push(e)},e.prototype.unsubscribe=function(t){this.observers.filter(function(e){return e!==t})},e.prototype.notify=function(t){this.observers.forEach(function(e){e(t)})},e);function e(){this.observers=[]}n.prototype.get=function(e){var t;return this.cache.has(e)?(t=this.cache.get(e),this.cache.delete(e),this.cache.set(e,t),t):null},n.prototype.put=function(e,t){this.cache.has(e)?this.cache.delete(e):this.cache.size>=this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,t)};var K=n;function n(e){this.cache=new Map,this.capacity=10,this.capacity=e}function r(e){var t=[];return Array.from(e).forEach(function(e){e instanceof Element&&("img"===e.nodeName.toLocaleLowerCase()?t.push(e):null!=e&&e.querySelectorAll&&(e=e.querySelectorAll("img"),t=t.concat(Array.from(e))))}),t}var U=function(e){var t=[],n=[];return(e=void 0===e?[]:e).forEach(function(e){t.push.apply(t,s([],N(r(e.addedNodes)),!1)),n.push.apply(n,s([],N(r(e.removedNodes)),!1))}),[t,n]},u="undefined"!=typeof IntersectionObserver,Q=(f.prototype.set=function(e){var t;u&&null!=(t=this.intersectionObserver)&&t.observe(e),this.record.set(e,{visible:!1,observer:this.intersectionObserver})},f.prototype.del=function(e){var t;null!=(t=this.record.get(e))&&t.visible||!u||null!=(t=this.intersectionObserver)&&t.unobserve(e),this.record.delete(e)},f.prototype.find=function(e){var t,n,r=null;try{for(var o=M(this.record),i=o.next();!i.done;i=o.next()){var a=N(i.value,2),u=a[0],c=a[1];if(u.currentSrc===e){r=x({target:u},c);break}}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r},f);function f(){var n=this;this.record=new Map,this.intersectionObserver=null,u&&(this.intersectionObserver=new IntersectionObserver(function(e){e.forEach(function(e){var t;(e.isIntersecting||0<e.intersectionRatio)&&((t=n.record.get(e.target))&&n.record.set(e.target,x(x({},t),{visible:!0})),null!=(t=n.intersectionObserver)&&t.unobserve(e.target))})},{rootMargin:"200px"}))}function p(i,a,u){var c=1;return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=i.apply(void 0,s([],N(e),!1)),r=c+=2,o="string"==typeof e[0]?e[0]:e[0].url;a(r,o);return n.then(function(){u(r)},function(){u(r)}),n}}function h(n,o,i){var a=0;return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=a+=2;return o(r,this._url),l(this,"onreadystatechange",function(n){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 4===this.readyState&&i(r),n&&n.apply(this,e)}})(),n.apply(this,e)}}function v(l,f,e,d,p,h,v){if(void 0===l&&(l=k()),void 0===f&&(f=A()),void 0===e&&(e=k()&&window.location),void 0===d&&(d=function(){if("function"==typeof XMLHttpRequest&&y(XMLHttpRequest))return XMLHttpRequest}()),void 0===p&&(p=function(){if(k()&&t(window.performance))return window.performance}()),void 0===h&&(h=function(){if(k()&&y(window.MutationObserver))return window.MutationObserver}()),void 0===v&&(v=function(){if(k()&&y(window.PerformanceObserver))return window.PerformanceObserver}()),f&&l&&e)return function(e,t){var n=e.debug,r=e.sample_rate,y=void 0===r?X:r,r=e.ignoreUrls,g=void 0===r?[]:r,b=F("imageReport",n);b("图片插件已注册，version:",ee);function u(e){b("图片资源上报",e),t&&t({ev_type:Z,payload:e})}var o,m=N(j(p),2)[1],w=new Q,c=new K(10),e=N(I(),3),S=e[0],_=e[1],s=e[2],O=N(V(l,d,function(e){return b("before http 请求, url:",e),!0},function(e){e=O.get(e);b("after http 请求, url:",e),e&&O.size-1<Y&&J.notify({ev_type:B,payload:{url:e,remainConnections:Y-(O.size-1)}})}),1)[0],r=N(D(h,function(e){var e=N(U(e),2),t=e[0],e=e[1];(t.length||e.length)&&b("监听到DOM变更",t,e),t.forEach(function(e){return w.set(e)}),e.forEach(function(e){return w.del(e)})}),2),n=r[0],i=r[1],e=(n(f,{childList:!0,subtree:!0,characterData:!1,attributes:!1}),N(W(v,function(e){var t,n,r,o,i,a,u,c,s,l,f,d,p,h,v,y,m;"img"!==e.initiatorType&&"css"!==e.initiatorType||(null!=(v=C(g))&&v.test(e.name)||(b("监听到resource",e),m=(v=e.toJSON()).name,y=v.initiatorType,t=v.transferSize,n=v.duration,r=v.encodedBodySize,o=v.decodedBodySize,i=v.redirectStart,a=v.redirectEnd,u=v.serverTiming,c=v.domainLookupStart,s=v.domainLookupEnd,l=v.connectStart,f=v.connectEnd,d=v.secureConnectionStart,p=v.requestStart,h=v.responseStart,v=v.responseEnd,"img"===(y={name:m,source:y,dpr:Math.round(null!=(m=null===window||void 0===window?void 0:window.devicePixelRatio)?m:1),needCompress:!1,needSizeOptim:!1,needFormatOptim:!1,hitLocalCache:0===t||void 0===t&&0===n,hitCdnCache:0<=(u||[]).findIndex(function(e){return"cdn-cache"===e.name&&0<=e.description.toLocaleLowerCase().indexOf("hit")}),size:0!==o?r:0,duration:n,redirect:a-i,dns:s-c,tcp:f-l,ssl:void 0===d||d<=0?0:f-d,request:void 0===p||p<=0?0:h-p,download:void 0===h||h<=0?0:v-h,timingDetail:e.toJSON()}).source&&(m=w.find(e.name),b("匹配到img",m,w.record),m&&(y=x(x({},y),{isLazyLoad:Boolean(m.visible),width:(null==(t=m.target)?void 0:t.naturalWidth)||0,height:(null==(u=m.target)?void 0:u.naturalHeight)||0,viewerWidth:null==(o=m.target)?void 0:o.width,viewerHeight:null==(r=m.target)?void 0:r.height}))),J.notify({ev_type:H,payload:y})))}),2)),r=e[0],a=e[1],E=function(i){return z(void 0,void 0,void 0,function(){var t,n,r,o;return R(this,function(e){switch(e.label){case 0:return(b("进行中的请求数：".concat(O.size)),0<Y-O.size)?(t=c.get(i.name))?(b("命中缓存header",i.name,t),[3,3]):[3,1]:[3,4];case 1:return[4,q(i.name)];case 2:t=e.sent(),c.put(i.name,t),e.label=3;case 3:if(o=(n=t||{}).format,r=n.status,n=n.contentLength,b("response header：",o,r),"css"===i.source){if(null==o||!o.startsWith("image/"))return[2]}else if((null==o||!o.startsWith("image/"))&&Number(r)<400)return[2];return o=x(x({},i),{format:!o||!String(o).startsWith("image/")||null==(o=o.split(/[,;]/)[0])?void 0:o.slice(6),status:r}),!Number(o.size)&&Number(r)<400&&0<Number(n)&&(o.size=Number(n)),r=P(o),u(x(x({},o),r)),[3,5];case 4:_(i.name,x({},i)),e.label=5;case 5:return[2]}})})},L=function(i,a){return z(void 0,void 0,void 0,function(){var t,n,r,o;return R(this,function(e){switch(e.label){case 0:return(t=c.get(i))?(b("命中缓存header",i,t),[3,3]):[3,1];case 1:return[4,q(i)];case 2:t=e.sent(),c.put(i,t),e.label=3;case 3:if(o=(n=t||{}).format,r=n.status,n=n.contentLength,b("response header：",o,r),"css"===a.source){if(null==o||!o.startsWith("image/"))return s(i),[2]}else if((null==o||!o.startsWith("image/"))&&Number(r)<400)return s(i),[2];return o=x(x({},a||{}),{format:!o||!String(o).startsWith("image/")||null==(o=o.split(/[,;]/)[0])?void 0:o.slice(6),status:r}),!Number(o.size)&&Number(r)<400&&0<Number(n)&&(o.size=Number(n)),r=P(o),u(x(x({},o),r)),s(i),[2]}})})};J.subscribe(function(e){var t,n,r,o,i;if(e.ev_type===H){var a=m()-(null==(a=null==(a=e.payload)?void 0:a.timingDetail)?void 0:a.responseEnd);if(b("资源加载事件: ",e.payload.name),b("资源完成加载时间: ",null==(i=null==(i=e.payload)?void 0:i.timingDetail)?void 0:i.responseEnd),b("时间间隔: ",a),b("是否命中本地缓存: ",null==(i=e.payload)?void 0:i.hitLocalCache),!T(y))return;if(!$)return void _(e.payload.name,x({},e.payload));E(e.payload)}if(e.ev_type===B&&$){if(b("http请求完成事件"),e.payload.remainConnections<=0)return;try{for(var u=M(S),c=u.next();!c.done;c=u.next()){var s=N(c.value,2),l=s[0];if(null==(v=s[1])||!v.__lock){_(l,x(x({},v),{__lock:!0})),L(l,v);break}}}catch(e){t={error:e}}finally{try{c&&!c.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}}if(e.ev_type===G&&e.payload.pageLoad){b("pageload 事件");try{for(var f=M(S),d=f.next();!d.done;d=f.next()){var p=N(d.value,2),h=p[0],v=p[1];if(!(0<Y-O.size))break;null!=v&&v.__lock||(_(h,x(x({},v),{__lock:!0})),L(h,v))}}catch(e){r={error:e}}finally{try{d&&!d.done&&(o=f.return)&&o.call(f)}finally{if(r)throw r.error}}$=!0}}),r(te),o=function(){J.notify({ev_type:G,payload:{pageLoad:!0}})},n=k(),e=A(),n&&e&&("complete"===e.readyState?o():n.addEventListener("load",function(){setTimeout(function(){o()},0)},!1));return[function(){b("插件销毁"),i(),a()}]}}var I=function(){var n=new Map;return[n,function(e,t){return n.set(e,t)},function(e){return n.delete(e)}]},V=function(e,t,n,r){function o(e,t){n&&n(t)&&c(e,t)}function i(e){r&&r(e),s(e)}var a=N(I(),3),u=a[0],c=a[1],s=a[2];return t&&l(t.prototype,"send",h)(o,i),e&&l(e,"fetch",p)(o,i),[u]},q=function(r){return z(void 0,void 0,void 0,function(){var t,n;return R(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,fetch(r,{cache:"force-cache"})];case 1:return t=e.sent(),n=t.headers,[2,{status:t.status,format:n.get("content-type")||"",contentLength:Number(n.get("content-length"))||0}];case 2:return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.log.apply(console,s(["[SDK]",Date.now(),(""+o++).padStart(8," ")],N(e),!1))}("获取header失败",e.sent()),[2,null];case 3:return[2]}})})},P=function(e){var t={needCompress:!1,needSizeOptim:!1,needFormatOptim:!1};if(!e.size)return t;o=(l=e).width,c=l.height,i=void 0===(i=l.format)?"":i,l=l.size,r=navigator&&navigator.userAgent.toLocaleLowerCase().includes("chrome"),s={},/(jpeg|png|bmp)/.test(i)&&(o&&c?(n=Math.round(Math.max(l-o*c*.2,0)),r?(o=Math.round(Math.max(l-o*c/6,0)),s.needFormatOptim=0<o,s.needFormatOptim&&(s.webpSavings=n,s.avifSavings=o)):(s.needFormatOptim=0<n,s.needFormatOptim&&(s.webpSavings=n))):(s.needFormatOptim=!0,s.webpSavings=Math.round(/png/.test(i)?.26*l:.3*l),r&&(s.avifSavings=Math.round(/png/.test(i)?.408*l:.44*l)))),/gif/.test(i)&&(s.needFormatOptim=!0,s.webpSavings=.65*l,r&&(s.avifSavings=.65*l));var n,r,o,i,a,u,c=s,s=(n=(o=e).width,i=o.height,r=void 0===(r=o.format)?"":r,o=o.size,l={},n&&i&&(/(jpeg|bmp)/.test(r)&&(a=o-n*i*.25,l.needCompress=0<a,l.needCompress&&(l.compressSavings=Math.round(a))),/png/.test(r)&&(a=o-n*i*4*.2*.3,l.needCompress=0<a,l.needCompress&&(l.compressSavings=Math.round(a)))),l),l=(o=(r=e).width,i=e.height,a=e.viewerWidth,l=e.viewerHeight,u=e.dpr,r=e.size,e={},o&&i&&a&&l&&(e.needSizeOptim=0<(a=1-a*l*u*u/(o*i)),e.needSizeOptim&&(e.resizeSavings=Math.round((1-a)*r))),e);return x(x(x(x({},t),c),s),l)},H="image_resource",B="http_custom",G="pageload",Z="image",X=.1,ee="0.2.2",te="resource",Y=8,J=new d,$=!1,m={sample_rate:X};return function(n){return void 0===n&&(n=m),{name:"imageReport",setup:function(t){t.on("init",function(){var e=N(function(e,t,n,r){void 0===t&&(t={}),void 0===r&&(r=[]);try{var o=e.apply(void 0,s([],N(r),!1));return o&&o(t,n)||[]}catch(e){return i(e),[]}}(v,n,t.report.bind(t)),1)[0];t.on("beforeDestroy",function(){e()})})}}}});
